version: '3'

services:
  ldap:
    build:
      context: './'
      dockerfile: './Dockerfile-ldap'
    image: 'zimbra/zmc-ldap'
    volumes:
      - ~/src/:/src/
    hostname: 'zmc-ldap'
    networks:
      default:
        aliases:
          - 'zmc-ldap'
        ipv4_address: '10.0.0.2'
    ports:
      - '7389:389'
      - '7000:5000'
  mta:
    build:
      context: './'
      dockerfile: './Dockerfile-mta'
    image: 'zimbra/zmc-mta'
    volumes:
      - ~/src/:/src/
    hostname: 'zmc-mta'
    networks:
      default:
        aliases:
          - 'zmc-mta'
        ipv4_address: '10.0.0.3'
    ports:
      - '6000:5000'
  mailbox:
    image: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    hostname: 'zmc-mailbox'
    networks:
      default:
        aliases:
          - 'zmc-mailbox'
        ipv4_address: '10.0.0.4'
    ports:
      - '9080:8080'
      - '9443:8443'
      - '9071:7071'
      - '9000:5000'
  mailbox1:
    build:
      context: './'
      dockerfile: './Dockerfile-mailbox'
    image: 'zimbra/zmc-mailbox'
    volumes:
      - ~/src/:/src/
      - blobvolume:/opt/zimbra/store
      - tmpvolume:/opt/zimbra/data/tmp
    hostname: 'zmc-mailbox'
    networks:
      default:
        ipv4_address: '10.0.0.14'
  mailbox2:
    build:
      context: './'
      dockerfile: './Dockerfile-mailbox'
    image: 'zimbra/zmc-mailbox'
    volumes:
      - ~/src/:/src/
      - blobvolume:/opt/zimbra/store
      - tmpvolume:/opt/zimbra/data/tmp
    hostname: 'zmc-mailbox'
    networks:
      default:
        ipv4_address: '10.0.0.15'
  mysql:
    build:
      context: './'
      dockerfile: './Dockerfile-mysql'
    image: 'zimbra/zmc-mysql'
    volumes:
      - ~/src/:/src/
    hostname: 'zmc-mysql'
    networks:
      default:
        aliases:
          - 'zmc-mysql'
        ipv4_address: '10.0.0.10'
    ports:
      - '10000:5000'
  proxy:
    build:
      context: './'
      dockerfile: './Dockerfile-proxy'
    image: 'zimbra/zmc-proxy'
    volumes:
      - ~/src/:/src/
    hostname: 'zmc-proxy'
    networks:
      default:
        ipv4_address: '10.0.0.5'
    ports:
      - '8080:80'
      - '8443:443'
      - '8071:7071'
      - '8000:5000'
  solr1:
    image: solr:6.6-alpine
    ports:
      - "8983:8983"
    links:
      - zookeeper
    command: bash -c '/opt/solr/bin/solr start -f -z zookeeper:2181'
  solr2:
    image: solr:6.6-alpine
    links:
      - zookeeper
      - solr1
    command: bash -c '/opt/solr/bin/solr start -f -z zookeeper:2181'
  solr3:
    image: solr:6.6-alpine
    links:
      - zookeeper
      - solr1
      - solr2
    command: bash -c '/opt/solr/bin/solr start -f -z zookeeper:2181'
  zookeeper:
    image: jplock/zookeeper:3.4.8
    ports:
      - "2181:2181"
      - "2888:2888"
      - "3888:3888"
volumes:
  blobvolume: {}
  tmpvolume: {}
networks:
  default:
    driver: 'bridge'
    ipam:
      driver: 'default'
      config:
        - subnet: '10.0.0.0/24'
